<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bundle HTML to PDF - Policy Test UI</title>
    <link rel="stylesheet" href="../css/health-status.css" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f8f9fa;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        margin: 0 0 10px 0;
        font-size: 2.5rem;
        font-weight: 700;
      }

      .header p {
        margin: 0;
        opacity: 0.9;
        font-size: 1.1rem;
      }

      .back-button {
        display: inline-block;
        padding: 12px 24px;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        margin-top: 20px;
        transition: background-color 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .back-button:hover {
        background-color: rgba(255, 255, 255, 0.3);
      }

      .content {
        padding: 30px;
      }

      .section {
        margin-bottom: 40px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
      }

      .section-header {
        background-color: #f8f9fa;
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .section-title {
        margin: 0;
        font-size: 1.4rem;
        color: #495057;
        font-weight: 600;
      }

      .section-content {
        padding: 20px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .form-group textarea {
        min-height: 120px;
        resize: vertical;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .checkbox-group input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background-color: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background-color: #5a6fd8;
        transform: translateY(-1px);
      }

      .btn-success {
        background-color: #28a745;
        color: white;
      }

      .btn-success:hover {
        background-color: #218838;
      }

      .btn-danger {
        background-color: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background-color: #c82333;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #5a6268;
      }

      .btn-sm {
        padding: 8px 16px;
        font-size: 12px;
      }

      .page-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
        transition: all 0.3s;
      }

      .page-item.editing {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .page-header {
        background-color: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .page-title {
        margin: 0;
        font-size: 1.1rem;
        color: #495057;
        font-weight: 600;
      }

      .page-actions {
        display: flex;
        gap: 10px;
      }

      .page-content {
        padding: 20px;
      }

      .page-content.disabled {
        opacity: 0.6;
        pointer-events: none;
      }

      .json-output {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 20px;
        margin-top: 20px;
      }

      .json-output pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 12px;
        line-height: 1.4;
      }

      .response-output {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 20px;
        margin-top: 20px;
      }

      .response-output h3 {
        margin: 0 0 15px 0;
        color: #495057;
        font-size: 16px;
      }

      .response-output pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 14px;
        line-height: 1.4;
        color: #333;
        background-color: #fff;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
      }

      /* Loading spinner styles */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      .loading-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 300px;
      }

      .loading-content h3 {
        margin: 0 0 15px 0;
        color: #333;
      }

      .loading-content p {
        margin: 0;
        color: #666;
        font-size: 14px;
      }

      .hidden {
        display: none;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
      }

      .grid-4 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid-2,
        .grid-3,
        .grid-4 {
          grid-template-columns: 1fr;
        }

        .page-header {
          flex-direction: column;
          gap: 15px;
          align-items: flex-start;
        }

        .page-actions {
          width: 100%;
          justify-content: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Bundle HTML to PDF - Policy Test UI</h1>
        <p>
          Pre-configured with InsureDaily Policy Document data - all pages, CSS,
          headers, and content ready to use
        </p>
        <a href="../pages/api-docs.html#bundle-html2pdf" class="back-button"
          >‚Üê Back to Documentation</a
        >
      </div>

      <div class="content">
        <!-- Global Configuration -->
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Global Configuration</h2>
          </div>
          <div class="section-content">
            <div class="grid-2">
              <div class="form-group">
                <label for="documentTitle">Document Title</label>
                <input type="text" id="documentTitle" value="A PDF Document" />
              </div>
              <div class="form-group">
                <label for="pageSize">Page Size</label>
                <select id="pageSize">
                  <option value="A4">A4</option>
                  <option value="A3">A3</option>
                  <option value="Letter">Letter</option>
                  <option value="Legal">Legal</option>
                </select>
              </div>
            </div>

            <div class="grid-4">
              <div class="form-group">
                <label for="marginTop">Margin Top (mm)</label>
                <input type="text" id="marginTop" value="0" />
              </div>
              <div class="form-group">
                <label for="marginRight">Margin Right (mm)</label>
                <input type="text" id="marginRight" value="0" />
              </div>
              <div class="form-group">
                <label for="marginBottom">Margin Bottom (mm)</label>
                <input type="text" id="marginBottom" value="0" />
              </div>
              <div class="form-group">
                <label for="marginLeft">Margin Left (mm)</label>
                <input type="text" id="marginLeft" value="0" />
              </div>
            </div>

            <div class="grid-2">
              <div class="form-group">
                <label for="headerHeight">Header Height (mm)</label>
                <input type="text" id="headerHeight" value="15" />
              </div>
              <div class="form-group">
                <label for="footerHeight">Footer Height (mm)</label>
                <input type="text" id="footerHeight" value="10" />
              </div>
            </div>

            <!-- SafeFrame Options -->
            <h3
              style="
                margin: 30px 0 15px 0;
                color: #333;
                border-bottom: 2px solid #e9ecef;
                padding-bottom: 8px;
              "
            >
              SafeFrame Options
            </h3>
            <div class="grid-2">
              <div class="checkbox-group">
                <input type="checkbox" id="safeFrameEnabled" checked />
                <label for="safeFrameEnabled">Enable SafeFrame</label>
              </div>
              <div class="form-group">
                <label for="safeFrameStroke">Stroke Width (px)</label>
                <input type="text" id="safeFrameStroke" value="0" />
              </div>
              <div class="form-group">
                <label for="safeFrameColor">Stroke Color</label>
                <input type="color" id="safeFrameColor" value="#000000" />
              </div>
              <div class="form-group">
                <label for="safeFrameTopOffset">Top Offset (px)</label>
                <input type="text" id="safeFrameTopOffset" value="0" />
              </div>
              <div class="form-group">
                <label for="safeFrameBottomOffset">Bottom Offset (px)</label>
                <input type="text" id="safeFrameBottomOffset" value="0" />
              </div>
              <div class="form-group">
                <label for="safeFrameLeftOffset">Left Offset (px)</label>
                <input type="text" id="safeFrameLeftOffset" value="0" />
              </div>
              <div class="form-group">
                <label for="safeFrameRightOffset">Right Offset (px)</label>
                <input type="text" id="safeFrameRightOffset" value="0" />
              </div>
            </div>

            <!-- Pagination Options -->
            <h3
              style="
                margin: 30px 0 15px 0;
                color: #333;
                border-bottom: 2px solid #e9ecef;
                padding-bottom: 8px;
              "
            >
              Pagination Options
            </h3>
            <div class="checkbox-group">
              <input type="checkbox" id="useBuiltInPaginator" checked />
              <label for="useBuiltInPaginator">Use Built-in Paginator</label>
            </div>

            <!-- Security Options -->
            <h3
              style="
                margin: 30px 0 15px 0;
                color: #333;
                border-bottom: 2px solid #e9ecef;
                padding-bottom: 8px;
              "
            >
              Security Options
            </h3>
            <div class="grid-2">
              <div class="checkbox-group">
                <input type="checkbox" id="sanitizeHtml" checked />
                <label for="sanitizeHtml">Sanitize HTML</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="allowExternalResources" checked />
                <label for="allowExternalResources"
                  >Allow External Resources</label
                >
              </div>
            </div>

            <div class="form-group">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                "
              >
                <label for="globalCSS">Default CSS</label>
                <div>
                  <button
                    class="btn btn-sm btn-primary"
                    onclick="toggleGlobalEdit('globalCSS')"
                    id="globalCSS-btn"
                  >
                    Edit
                  </button>
                </div>
              </div>
              <textarea
                id="globalCSS"
                placeholder="Enter global CSS styles here..."
                onchange="updateGlobalField('globalCSS', this.value)"
              ></textarea>
            </div>

            <div class="form-group">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                "
              >
                <label for="globalJS">Default JavaScript</label>
                <div>
                  <button
                    class="btn btn-sm btn-primary"
                    onclick="toggleGlobalEdit('globalJS')"
                    id="globalJS-btn"
                  >
                    Edit
                  </button>
                </div>
              </div>
              <textarea
                id="globalJS"
                placeholder="Enter global JavaScript code here..."
                onchange="updateGlobalField('globalJS', this.value)"
              ></textarea>
            </div>

            <div class="form-group">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                "
              >
                <label for="globalHeader">Default Header</label>
                <div>
                  <button
                    class="btn btn-sm btn-primary"
                    onclick="toggleGlobalEdit('globalHeader')"
                    id="globalHeader-btn"
                  >
                    Edit
                  </button>
                </div>
              </div>
              <textarea
                id="globalHeader"
                placeholder="Enter global header HTML here..."
                onchange="updateGlobalField('globalHeader', this.value)"
              ></textarea>
            </div>

            <div class="form-group">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                "
              >
                <label for="globalFooter">Default Footer</label>
                <div>
                  <button
                    class="btn btn-sm btn-primary"
                    onclick="toggleGlobalEdit('globalFooter')"
                    id="globalFooter-btn"
                  >
                    Edit
                  </button>
                </div>
              </div>
              <textarea
                id="globalFooter"
                placeholder="Enter global footer HTML here..."
                onchange="updateGlobalField('globalFooter', this.value)"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Pages Management -->
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Pages Management</h2>
            <div style="display: flex; gap: 10px">
              <button class="btn btn-success" onclick="saveAllPages()">
                üíæ Save All Pages
              </button>
              <button class="btn btn-primary" onclick="addNewPage()">
                + Add New Page
              </button>
            </div>
          </div>
          <div class="section-content">
            <div id="pagesContainer">
              <!-- Pages will be dynamically added here -->
            </div>
          </div>
        </div>

        <!-- JSON Output -->
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Generated JSON</h2>
            <div>
              <button class="btn btn-secondary" onclick="generateJSON()">
                Generate JSON
              </button>
              <button
                class="btn btn-primary"
                onclick="generatePDF()"
                id="generatePDFBtn"
              >
                Generate PDF
              </button>
            </div>
          </div>
          <div class="section-content">
            <div class="json-output">
              <pre id="jsonOutput">
Click "Generate JSON" to see the output...</pre
              >
            </div>
            <div
              class="response-output"
              id="responseOutput"
              style="display: none; margin-top: 20px"
            >
              <h3>API Response</h3>
              <pre id="responseText"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let pageCounter = 0;
      let pages = [];

      // Global field states
      let globalFields = {
        globalCSS: { isEditing: false, isSaved: false, originalValue: "" },
        globalJS: { isEditing: false, isSaved: false, originalValue: "" },
        globalHeader: { isEditing: false, isSaved: false, originalValue: "" },
        globalFooter: { isEditing: false, isSaved: false, originalValue: "" },
      };

      // Initialize with sample data
      function initializeSampleData() {
        const globalCSS = `html, body {
  margin-top: auto;
  margin-bottom: 0;
  margin-left: 0px;
  margin-right: auto;
  padding: 0;
  background: #fff;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";
  background-color: white;
}

.document { background:#fff; padding:40px }

.page {
  width: var(--page-width);
  height: var(--page-height);
  margin: -20px -20px -20px 0px;
  background: #fff;
  position: relative; /* required for absolute children */
  overflow: hidden;
  page-break-after: always;
  background-color: white;
}
.page:last-child { page-break-after: auto }

.header {
  height: var(--header-h);
  padding: 0 var(--margin);
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid #e5e7eb;
  box-sizing: border-box;
  z-index: 10; /* sits above body */
}
.header .center {
  flex: 1;
  text-align: center;
  font-size: 10px;
  color: var(--muted);
  letter-spacing: .04em
}
.header img { height:18mm; width:auto; object-fit:contain }

.header-div{ width:100%; display:grid; justify-content:end }
.header-inner-div{ display:flex; flex-direction:row-reverse }
.header-inner-div-two-items{ display:flex; flex-direction:row; gap:60px; }
.logo-right-width{ width:60% !important; }

/* pin body between header/footer instead of hard-coded height */
.body {
  position: absolute;
  top: calc(var(--header-h));
  bottom: calc(var(--footer-h));
  left: 0;
  right: 0;
  padding: 5mm 10mm 5mm 10mm;
  overflow: hidden;
  box-sizing: border-box;
  z-index: 1;
}

.footer {
  height: var(--footer-h);
  padding: 0 var(--margin);
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: var(--muted);
  font-size: 10px;
  border-top: 1px solid #e5e7eb;
  position: absolute;
  left: 0; right: 0; bottom: 0;
  box-sizing: border-box;
  z-index: 10; /* sits above body */
}
.footer .pagecount { font-variant-numeric: tabular-nums }

h1{ font-size:24px; margin:0 0 8mm 0 }
h2{ font-size:20px; margin:0 0 8mm 0 }
h4{ font-size:14px; margin:2mm 0 1mm 0 }
p{ line-height:1.35; margin:0 0 2mm 0 }

.justify-text{ text-align:justify !important; }

.address-blocks{
  display:flex; justify-content:space-between; align-items:flex-start;
  margin-bottom:10px; font-size:12px; line-height:1.4;
}
.address-left,.address-right{ max-width:45%; }
.address-right{ text-align:right; }
.address-right .email{ margin-top:8px; }
.address-right .date{ margin-top:12px; }

.flow > * { break-inside: avoid }

.info-section{ margin-top:5px; font-size:14px; line-height:1.4; }
.info-section p{ margin-bottom:4px; color:var(--muted); }

.info-lists{ display:flex; justify-content:space-between; gap:40px; }
.info-lists ul{ margin:0; padding-left:20px; }
.info-lists li{ margin-bottom:6px; }
.info-section ul li{ margin-bottom:0px; }

ul{ margin-top:0px; margin-bottom:10px; }

.section-title{ font-size:22px; font-weight:700; color:#333; margin:0 0 12px 0; }
.totals-row{ display:flex; justify-content:space-between; align-items:baseline; margin:6px 0 14px 0; font-weight:600; }
.totals-label{ max-width:70%; color:#444; line-height:1.3; }
.totals-amount{ min-width:120px; text-align:right; }

.premium-table{ width:100%; border-collapse:collapse; margin:0 0 18px 0; font-size:14px; }
.premium-table th,.premium-table td{ border-top:1px solid #dcdcdc; padding:8px 10px; }
.premium-table th{ text-align:left; font-weight:700; background:#f8f8f8; }
.premium-table td:last-child,.premium-table th:last-child{ text-align:right; width:18%; }

.divider{ height:1px; background:#dcdcdc; margin:7px 0 7px 0; }
.h2-like{ font-size:20px; font-weight:700; color:#333; margin:0 0 10px 0; }
.muted{ color:var(--muted); line-height:1.6; margin:0 0 10px 0; }

.forcePageEnd{ page-break-after:always; break-after:page; }

body{ position:relative; }
.body .flow{ padding-bottom:3mm; }
.flow > * { break-inside: avoid; }

.claims-helpline{ text-align:center; margin:20px 0; }
.claims-helpline p{ font-size:16px; color:#333; margin-bottom:10px; }
.claims-number{ display:inline-block; background-color:#4a5c85; color:white; font-size:22px; font-weight:bold; padding:10px 20px; border-radius:5px; }

.schedule-doc{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#333; max-width:760px; margin:0 auto; page-break-inside:avoid; }
.schedule-doc h1{ font-size:26px; font-weight:700; margin:20px 0 12px; color:#2b2b2b; }
.schedule-doc .reg{ font-weight:800; }

.kv-table{ width:100%; border-collapse:collapse; table-layout:fixed; }
.kv-table th,.kv-table td{ padding:2px 5px; vertical-align:top; font-size:14px; }
.kv-table th{ width:42%; text-align:left; font-weight:600; color:#4b4b4b; }
.kv-table td{ color:#222; word-wrap:break-word; }
.kv-table tr{ border-bottom:1px solid #dcdcdc; }
.kv-table tr:first-of-type{ border-top:1px solid #dcdcdc; }
.kv-table .section th{ padding-top:16px; padding-bottom:8px; font-size:16px; font-weight:700; color:#2f2f2f; border-top:2px solid #cfcfcf; border-bottom:1px solid #dcdcdc; }
.kv-table .section td{ display:none; }
.kv-table-p{ border-bottom:1px solid #dcdcdc; text-align:left; font-weight:600; color:#4b4b4b; font-size:14px; padding:2px; }
.kv-table-no-top-border{ border-top:0px solid #dcdcdc !important; }

.certificate-intro{ margin:6px 0 10px; }
.legal-note{ margin:0px 0; font-size:13px; line-height:1.45; text-align:justify; color:#444; }
.legal-note.small{ font-size:12px; color:var(--muted); }

.signatory-block{ margin:10px 0 6px; }
.signer-name{ font-weight:700; }
.signer-role,.signer-address{ color:var(--muted); font-size:13px; }

.devon-bay-gap{ gap:122px !important; }
.center-text{ text-align:center; }

.callout{ border:1px solid #bfc5cf; padding:10px 12px; margin-top:8px; page-break-inside:avoid; background:#fff; }

.matrix-table{ width:100%; border-collapse:collapse; font-size:14px; table-layout:fixed; margin-top:6px; }
.matrix-table th,.matrix-table td{ border:1px solid #dcdcdc; padding:4px 8px; vertical-align:top; }
.matrix-table thead th{ background:#f8f8f8; font-weight:600; text-align:left; }

.small-note{ margin:6px 0 0 0; font-size:12.5px; color:var(--muted); }

.benefits-title{ text-align:center; font-weight:700; letter-spacing:.04em; padding:6px 0; margin:6px 0 12px 0; border-top:2px solid #000; border-bottom:2px solid #000; }

.helpline-orange{ text-align:center; margin:5px 0 10px 0; font-weight:700; font-size:26px; line-height:1.1; color:#e07b3f; }
.helpline-orange .label{ margin-right:16px; display:inline-block; }
.helpline-orange .phone{ letter-spacing:.02em; white-space:nowrap; }

.note-asterisk{ margin:8px 0 6px 0; font-size:13px; color:var(--muted); }

/* ===== Header/Footer ===== */
.hdr{
  height: var(--header-h);
  padding: 5px;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  flex-wrap: nowrap;       /* single line */
  gap: 0;
  width: 100%;
  overflow: hidden;
}
/* single-item alignment */
.hdr[data-align="left"]   { justify-content: flex-start; }
.hdr[data-align="center"] { justify-content: center; }
.hdr[data-align="right"]  { justify-content: flex-end; }
/* multi-item distribution (optional) */
.hdr[data-mode="edges"]  { justify-content: space-between; }
.hdr[data-mode="spread"] { justify-content: space-evenly; }
/* equalize all slots (optional) */
.hdr[data-equalize="true"] > .slot { flex: 1 1 0; }

.hdr > .slot{
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 0;
}
.hdr > .slot img,
.hdr > .slot svg{
  display: block;
  max-height: calc(var(--header-h) - 10px); /* header-h minus 5px top+bottom */
  width: auto;
  max-width: 100%;
  object-fit: contain;
}
.hdr > .slot.text{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Footer utility with the same API */
.ftr{
  height: var(--footer-h);
  padding: 5px;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
}
.ftr[data-align="left"]   { justify-content: flex-start; }
.ftr[data-align="center"] { justify-content: center; }
.ftr[data-align="right"]  { justify-content: flex-end; }
.ftr > .slot{
  display: flex;
  align-items: center;
  min-width: 0;
}
.ftr > .slot.text{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

@media print {
  body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .schedule-doc{ margin:0; }
  .kv-table th, .kv-table td{ padding:8px 6px; font-size:12.5px; }
}
@media print {
  .document{ padding:0 }
  .page{ box-shadow:none; margin:0 }
}
@page { size: 210mm 297mm; margin: 0; }`;

        const globalHeader = `<header>
  <div class="hdr" data-align="right">
    <div class="slot">
      <img alt="Logo" src="https://www.insuredaily.co.uk/web/assets/images/logo/InsureDaily_short_term_car_insurance_logo.webp">
    </div>
  </div>
</header>`;

        const globalFooter = `<footer>
 <div class="ftr" data-align="center">
    <div class="slot text">
      InsureDaily is a trading name of Ramasis Limited who is authorised and regulated by the Financial Conduct Authority - 306294
    </div>
  </div>
</footer>`;

        const globalJS = `window.addEventListener('load', () => {
    const BUFFER = 2; // px ‚Äì avoids rounding/paint edge cases

    function ensureFlow(page) {
        const body = page.querySelector('.body');
        let flow = body.querySelector(':scope > .flow');

        // If there's no .flow, create one and move everything into it
        if (!flow) {
            flow = document.createElement('div');
            flow.className = 'flow';
            // move all existing children into flow
            const kids = Array.from(body.childNodes);
            body.innerHTML = '';
            kids.forEach(k => flow.appendChild(k));
            body.appendChild(flow);
        }
        return { body, flow };
    }

    function makePageAfter(prevPage) {
        const clone = prevPage.cloneNode(true);

        // clear the new page's body and create a fresh .flow container
        const cBody = clone.querySelector('.body');
        cBody.innerHTML = '';
        const cFlow = document.createElement('div');
        cFlow.className = 'flow';
        cBody.appendChild(cFlow);

        prevPage.parentNode.insertBefore(clone, prevPage.nextSibling);
        return { page: clone, body: cBody, flow: cFlow };
    }

    function paginate(page) {
        const { body, flow } = ensureFlow(page);
        const items = Array.from(flow.children);
        flow.innerHTML = '';

        const pages = [page];
        let cur = { page, body, flow };

        for (const el of items) {
            // manual breaker still supported
            if (el.classList && el.classList.contains('forcePageEnd')) {
                if (cur.flow.childElementCount > 0) cur = makePageAfter(cur.page);
                continue;
            }

            cur.flow.appendChild(el);

            const elBottom = el.getBoundingClientRect().bottom;
            const bodyBottom = cur.body.getBoundingClientRect().bottom;

            // If it doesn't fit visually on this page, move it to the next
            if (elBottom > bodyBottom - BUFFER) {
                cur.flow.removeChild(el);
                const next = makePageAfter(cur.page);
                next.flow.appendChild(el);
                cur = next;
            }
        }
        return pages;
    }

    // Run for every .page (no need to pre-add .flow)
    const originals = Array.from(document.querySelectorAll('.page'));
    let allPages = [];
    for (const pg of originals) {
        const created = paginate(pg);
        allPages = allPages.concat(created);
    }

    // Update page numbers
    const total = allPages.length;
    allPages.forEach((pg, i) => {
        const cur = pg.querySelector('.footer .pagecount .current');
        const tot = pg.querySelector('.footer .pagecount .total');
        if (cur) cur.textContent = String(i + 1);
        if (tot) tot.textContent = String(total);
    });
});`;

        // Set initial values (raw content, like Page Body HTML)
        document.getElementById("globalCSS").value = globalCSS;
        document.getElementById("globalHeader").value = globalHeader;
        document.getElementById("globalFooter").value = globalFooter;
        document.getElementById("globalJS").value = globalJS;

        // Initialize global fields in editing mode (like Page Body HTML)
        globalFields.globalCSS = {
          isEditing: true,
          isSaved: false,
          originalValue: globalCSS,
        };
        globalFields.globalHeader = {
          isEditing: true,
          isSaved: false,
          originalValue: globalHeader,
        };
        globalFields.globalFooter = {
          isEditing: true,
          isSaved: false,
          originalValue: globalFooter,
        };
        globalFields.globalJS = {
          isEditing: true,
          isSaved: false,
          originalValue: globalJS,
        };

        // Set initial button states to "Save" since fields start in editing mode
        document.getElementById("globalCSS-btn").textContent = "Save";
        document.getElementById("globalCSS-btn").className =
          "btn btn-sm btn-success";
        document.getElementById("globalHeader-btn").textContent = "Save";
        document.getElementById("globalHeader-btn").className =
          "btn btn-sm btn-success";
        document.getElementById("globalFooter-btn").textContent = "Save";
        document.getElementById("globalFooter-btn").className =
          "btn btn-sm btn-success";
        document.getElementById("globalJS-btn").textContent = "Save";
        document.getElementById("globalJS-btn").className =
          "btn btn-sm btn-success";

        // Set document title to policy document
        document.getElementById("documentTitle").value =
          "InsureDaily ‚Äì Policy Document";

        // Add all policy pages
        addAllPolicyPages();
      }

      function addNewPage() {
        pageCounter++;
        const pageId = `page-${pageCounter}`;
        const page = {
          id: pageId,
          title: "A PDF page",
          pageNumber: pages.length + 1,
          sectionClass: "page",
          dataTitle: `Page ${pages.length + 1} Details`,
          showHeader: true,
          showFooter: true,
          body: '<main class="body"><div class="flow"><h1>Sample Page Content</h1><p>This is a sample page. Edit the content below.</p></div></main>',
          header: "",
          footer: "",
          customCSS: "",
          customJS: "",
          hasCustomCSS: false,
          hasCustomJS: false,
          hasCustomHeader: false,
          hasCustomFooter: false,
          isEditing: true,
          isSaved: false,
        };

        pages.push(page);
        // Update pageNumber after adding to array
        page.pageNumber = pages.length;
        renderPage(page);
      }

      function addAllPolicyPages() {
        // Clear existing pages
        pages = [];
        pageCounter = 0;

        // Add all 10 policy pages with their content
        addPolicyPage(
          "Policy Introduction",
          `<main class="body"><div class="address-blocks"><div class="address-left"><div>Reza Moghbel</div><div>9 Rhossilli Road, Rumney</div><div>Cardiff</div><div>Cardiff</div><div>CF3 3NY</div></div><div class="address-right"><div>InsureDaily.co.uk</div><div>28 Station Close</div><div>Potters Bar</div><div>Hertfordshire</div><div>EN6 1TL</div><div class="email">Email: info@insuredaily.co.uk</div><div class="date">13th August 2025</div></div></div><div class="flow"><p>Dear Reza</p><p class="justify-text">Thank you for choosing <b>InsureDaily</b> for your car insurance.Your insurance documentation is enclosed below, which contains important information about the cover and benefits you have in place. Please ensure you read them carefully, especially the <b>Statement of Facts</b>, and contact us immediately if there is anything you do not understand or you think is incorrect. Your insurance policy provides Comprehensive cover for the vehicle and during the period on the Certificate of Insurance.</p><p class="justify-text">We believe in going the extra mile for our customers and that is why if you arrange your motor insurance cover with us you will automatically be entitled to receive our <b>Customer Benefits, which include free Breakdown Assistance and ¬£250 Excess Refunded on a claim</b>, which are explained later on in this document.</p><p class="justify-text">Information relating to your insurance policy will be added to the <b>Motor Insurance Database (MID)</b> which is managed by the Motor Insurers Bureau (MIB). The information stored on it may be used by authorised bodies including the Police and the DVLA. Please be aware that the Motor Insurance Database (MID) can take up to seven days to be updated. We recommend you save a copy of this document to your phone.</p><div class="info-section"><p>The pages that follow include the following information:</p><div class="info-lists"><ul><li>Certificate of Motor Insurance for RK17NSY</li><li>Schedule of Insurance</li><li>Statement of Fact</li><li>Customer Benefits for InsureDaily customers</li></ul><ul><li>Premium and Cover Information</li><li>How to Make a Claim</li><li>Details of any Add-on products - <em>if purchased</em></li></ul></div></div><h4>Loyal Customer Discount</h4><p class="justify-text">If you wish to use our service again, you can gain a favourable rate by clicking the link below and using '<b>LOYAL</b>' as the Promotional Code when purchasing. The discount will be applied at the end. <b>This offer is only available when clicking through this link below</b>.</p><p><img width="160" height="48" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKAAAAAw" /></p><div class="info-section"><p>If you have any queries relating to your insurance or the Customer Benefits we have arranged for you, please contact us:</p><ul><li>By the LiveChat on our website during our working hours</li><li>By post to the address shown at the top of this letter</li><li>By email to <a href="mailto:info@insuredaily.co.uk">info@insuredaily.co.uk</a>, or simply visit <a href="https://www.insuredaily.co.uk/faqs">www.insuredaily.co.uk/faqs</a></li></ul></div><p class="justify-text">Our office opening hours are 9am-5pm Mon-Fri and 9am-1pm on Sat. We are closed on Sundays and public holidays.</p><div style="display:grid;place-items:center;"><img width="280" height="47" src="data:image/png;base64,iVBORw0KGgoAAAANSU" /></div></div></main>`
        );

        addPolicyPage(
          "Premium Information",
          `<main class="body"><h2 class="section-title">Your Premium information for RK17NSY</h2><div class="totals-row"><div class="totals-label">Total Amount including Insurance Premium Tax,<br />Administration Fee and Additional Covers</div><div class="totals-amount">¬£43.83</div></div><table class="premium-table" aria-label="Additional Covers"><thead><tr><th>Additional Covers (included in the total amount above)</th><th>Cost</th></tr></thead><tbody><tr><td>Excess Protection Insurance</td><td>¬£1.38</td></tr><tr><td>Legal Expenses</td><td>¬£1.29</td></tr><tr><td></td><td>¬£0.00</td></tr></tbody></table><div class="divider"></div><h4>Statement of Demands and Needs</h4><p class="muted justify-text">When selling you this policy, we do not provide you with a recommendation. You will need to decide whether or not this policy meets your demands and needs.</p><p class="muted justify-text">This policy is underwritten by Allianz. It will meet the demands and needs of those who require a short-term motor insurance policy on a comprehensive basis. The full details of cover provided, and restrictions can be found in the policy documents.</p></main>`
        );

        addPolicyPage(
          "Statement of Fact",
          `<main class="body"><div class="info-section"><h1>Statemment of Fact</h1><p class="muted justify-text"> Your policy has been issued on the basis of your confirmation in the Proposer's Declaration that the following statements about you (the Driver) and the Vehicle are correct. These form the basis of your policy which may be invalid if you do not meet the criteria stated. If you have a claim and any of the declarations you have made are incorrect, part or all of the claim may not be paid. Please read the following carefully and contact us immediately if any of the statements are incorrect.</p></div><div class="info-section"><h1>You have declared that you:</h1><ul><li>are aged between 21 and 75 and hold a current full and valid UK licence</li><li>are living in the UK, and have been continuously resident in the UK for the past 12 months</li><li>have had no more than 1 fault or 2 non-fault claims in the past 3 years</li><li>have not had an insurance policy cancelled, voided, refused or had a premium increase during the policy period, or had an insurance claim repudiated or declined</li><li>have no more than 6 penalty points, no driving convictions starting with codes DR, CD, DD, UT or DG or have not been disqualified from driving or had your licence revoked in the past 5 years</li><li>have never been convicted of any criminal offence or have any prosecution or police enquiry pending or awaiting trail</li><li>do not reside in a squat, static caravan, caravan, barge, house boat or have 'no fixed abode/address'</li><li>are not Unemployed, or have a Full or Part-Time occupation which is connected to the following trades or professions: Couriers, Fast Food Delivery, Licensed Taxi or Mini-Cab Driver, Parcel Delivery, Entertainment Profession, Professional Sportsperson or the Motor Trade</li></ul></div><div class="info-section"><h1>You have declared that the vehicle:</h1><ul><li>will only be used by the policyholder and named driver</li><li>is not a Licensed Taxi or Mini-Cab, Horsebox, Lorry, Minibus, Motor Caravan, Motor Home, Campervan, Recovery Vehicle or a Tipper</li><li>has a market value of over ¬£500 but less than ¬£65,000 - or less than ¬£50,000 when the driver is under 25 years of age</li><li>has no more than 7 seats, has a current MOT certificate (if required) and is not recorded as a category A or B insurance loss and does not have a Q plate</li><li>has not been modified or altered in any way (including optional extras). Vehicles modified to cater for a disabled person or converted to LPG are acceptable</li><li>is less than 25 years old</li><li>will only be used for social, domestic &amp; pleasure purposes and/or, in person by you, the Policyholder, for commuting or in connection with your work or business only</li><li>will not be used for hiring, letting on hire, carriage of passengers or goods for hire and reward, racing, pacemaking, use on any track, test circuit or off road activity, used in any contest, reliability or speed trail, or used in connection with the Motor Trade; is not owned/operated by, hired or rented from any Hire/Loan, Claims, Credit Hire or Accident Management Company</li><li>has not been seized or impounded by any Law Enforcement Agency</li><li>is not being exported outside of the UK or imported into the UK during this period of insurance cover and is based in the UK at the start and end of the policy cover period</li></ul></div><div class="forcePageEnd"></div><div class="info-section"><h1>You have confirmed that you are aware that this policy:</h1><ul><li>only covers the vehicle shown on the Certificate of Insurance and that Driving Other Cars is not covered under this policy</li><li>will not be used as evidence of insurance for the release of a vehicle impounded or confiscated by the Police or Local Authority</li></ul><p>It is an offence under the Road Traffic Act to make a false statement or to withhold information for the purpose of obtaining a Certificate of Motor Insurance. Allianz reserves the right to decline any proposal.</p></div><div class="info-section"><h1>You have also declared that:</h1><ul><li>You agree that the information you have provided about yourself is correct to the best of your knowledge and belief.</li><li>You agree that you understand and accept the terms laid out in the Proposer's Declaration, and confirmed in the Statement of Fact (above).</li><li>You are aware that InsureDaily only deals with one insurance company for each product and that you must therefore decide for yourself whether the policy is suitable for your needs.</li><li>You confirm that you have read and agree to the terms and conditions outlined in the Allianz Insurance Product Information Document and agree with InsureDaily's Terms of Business Agreement.</li><li>You are aware that you cannot make any changes to this insurance policy after your payment has been accepted.</li><li>If you decide to cancel this insurance policy at any point in time, you understand that the payment is non-refundable.</li></ul></div></main>`
        );

        addPolicyPage(
          "Accident Information",
          `<main class="body"><h1>In the Event of an Accident</h1><div class="info-section"><h4>Exchange the following details with the Third Party;</h4><ul><li>full names</li><li>telephone numbers</li><li>name the insurance policy is in (if not the actual driver)</li><li>policy number</li><li>registration of vehicles involved</li><li>the number of passengers</li><li>full names &amp; contact details of any witnesses</li></ul></div><p>Take photographs of damage to all vehicles and the scene of the accident, if safe to do so. Note the number of occupants in the other vehicle(s).</p><div class="info-section"><h4>Safety Measures</h4><ul><li>Stop your vehicle and move it to a safe location nearby.</li><li>Check to see if anyone is injured. Call 999 or 112 for medical assistance.</li><li>Do not leave the scene of the accident.</li><li>Make sure everyone involved moves to a safe location.</li><li>Contact the police. They will let you know if an officer needs to be present at the scene.</li></ul></div><div class="info-section"><h4>Safety Measures</h4><ul><li>Stay Calm - do not panic</li><li>Do not admit fault</li><li>Co-operate with police</li><li>Remain calm and polite</li></ul></div><div class="claims-helpline"><p><strong>To make a claim on your Motor Insurance policy, call our Claims Helpline on</strong></p><div class="claims-number">01707 518 337</div></div></main>`
        );

        addPolicyPage(
          "Schedule of Insurance",
          `<main class="body"><div class="schedule-doc"><h1>Schedule of Insurance <span class="reg">RK17NSY</span></h1><table class="kv-table"><tbody><tr><th>Policy Number:</th><td>995001005</td></tr><tr><th>Date and Time of Issue:</th><td>13/08/2025 at 11:29 hours</td></tr><tr><th>Reason for Issue:</th><td>Temporary Motor Insurance</td></tr><tr class="section"><th colspan="2">Your Details</th></tr><tr><th>Policyholder:</th><td>Reza Moghbel</td></tr><tr><th>Policyholder's Date of Birth:</th><td>07/04/1988</td></tr><tr><th>Policyholder's Address:</th><td>9 Rhossili Road Rumney Cardiff CF3 3NY</td></tr><tr><th>Policyholder's Contact Number:</th><td>Mobile: 07999999999 &nbsp;&nbsp;Home: Not Provided</td></tr><tr><th>Policyholder's Email Address:</th><td>r.moghbel@hotmail.com</td></tr><tr><th>Period of Insurance:</th><td>13/08/2025 at 17:55 hours to: 14/08/2025 at 17:55 hours</td></tr><tr><th>Number of Days:</th><td>ONE DAY</td></tr><tr><th>Vehicle Insured:</th><td>118d Sport</td></tr><tr><th>Registration Number:</th><td>RK17NSY</td></tr><tr><th>Owner / Registered Keeper:</th><td>Alex Jones 1 Rhossilli Road Rumney Cardiff CF3 3NX</td></tr></tbody></table></div></main>`
        );

        addPolicyPage(
          "Schedule Continued",
          `<main class="body"><div class="schedule-doc"><h1>Schedule of Insurance RK17NSY - Continued</h1><table class="kv-table"><tbody><tr><th>Accidental Damage</th><td>Compulsory: ¬£500</td></tr><tr><th>Fire:</th><td>Compulsory: ¬£500</td></tr><tr><th>Theft:</th><td>Compulsory: ¬£500</td></tr></tbody></table></div><h1>Additional Policy Excesses</h1><p>The following situations will activate Additional Policy Excesses - these are in addition to the Standard Policy Excess or any other excess.</p><p>In the event of an incident resulting in a claim under the policy where:<br/>i) there is a non-traceable responsible third party; or<br/>ii) the incident is a fault incident involving no other party</p><p>an additional excess of ¬£500 will apply. An Excess Reduction or Excess Protection policy does not cover this excess.</p><h1>Policy Endorsements</h1><p>B008 - PC Windscreen - If you use our approved repairers (0330 678 5591), there is no limit on the amount we will pay for windscreen damage under Section 4 of the document. If you use any other supplier the most we pay is ¬£100. You must pay the first ¬£75 if you claim for Windscreen damage under this insurance.</p><p>B014 - PC Comp Audio - The most we will pay for fitted Audio equipment under Section 2 and Section 3 of the policy document is ¬£500 unless it is the manufacturer's standard fitted equipment.</p><p>It is recommended that you print out and keep the documents with you when driving the insured vehicle. If you require a printed version your Schedule &amp; Certificate of Insurance, this can be sent out for free upon request emailed to info@insuredaily.co.uk - please be sure to include your full name, policy number and vehicle registration.</p><h1>Detecting and Preventing Fraud</h1><p>In order to keep premiums as low as possible for all of our customers, we participate in a number of industry initiatives to aid the prevention and detection of crime, especially insurance related fraud. We pass information to the Claims and Underwriting Exchange Register operated by Insurance Database Services Ltd (IDS Ltd), the Motor Insurance Anti-Fraud and Theft Register operated by the Association of British Insurers, and the UK Police.</p><p>We may search these registers and any other relevant databases in order to make decisions regarding the provision and administration of insurance and, when you make a claim, to validate your claims history or that of any person or property likely to be involved in the claim.</p></main>`
        );

        addPolicyPage(
          "Certificate of Insurance",
          `<main class="body"><div class="flow"><h1>Certificate of Temporary Motor Insurance</h1><p class="muted certificate-intro">This certificate is evidence that you have insurance to comply with the law. It is not valid if changed in any way. For full details of your insurance cover, please see your motor insurance schedule and your policy booklet.</p><table class="kv-table"><tbody><tr><th>1. Policy number:</th><td>9950001005</td></tr><tr><th>2. Certificate Number:</th><td>9950001005</td></tr><tr><th>3. Make and Model of Vehicle:</th><td>118d Sport</td></tr><tr><th>4. Registration Number:</th><td>RK17NSY</td></tr><tr><th>5. Name of Policyholder:</th><td>Reza Moghbel</td></tr><tr><th>6. Effective date of commencement of insurance for the purpose of the relevant law:</th><td>13/08/2025 at 17:55 hours</td></tr><tr><th>7. Date of expiry of insurance:</th><td>14/08/2025 at 17:55 hours</td></tr><tr><th>8. Persons entitled to drive:</th><td>Reza Moghbel only.</td></tr><tr><th>9. Limitations of use:</th><td>Use for Social, Domestic &amp; Pleasure purposes and/or in person by you, the Policyholder, for commuting or in connection with your work or business only, excluding the use for hiring, the letting on hire, the carriage of passengers or goods for hire or reward, racing, pacemaking, use on any track, test circuit or off road activity, use in any contest, reliability or speed trial, or use for any purpose in connection with the Motor Trade.</td></tr></tbody></table><p class="kv-table-p">10. The driving of other vehicles is not permitted under this insurance.</p><p class="kv-table-p">11. This temporary certificate of insurance cannot be used to secure the release of an impounded vehicle.</p><p class="legal-note">I hereby certify that the policy to which this Certificate relates satisfies the requirements of the relevant Law applicable in Great Britain, Northern Ireland, the Isle of Man, the island of Guernsey, the island of Jersey and the island of Alderney.</p><div class="divider"></div><h4>For and on behalf of</h4><h4>HIGHWAY INSURANCE COMPANY LTD.</h4><p class="muted">Authorised Insurers</p><div class="signatory-block"><div class="signer"><div class="signer-name">Nicola George</div><div class="signer-role">Allianz Personal Broker</div><div class="signer-address">57 Ladymead, Guildford, Surrey, GU1 1DB</div></div></div><p class="legal-note small">Note: For full details of the insurance cover, reference should be made to the Insurance Policy Document and Schedule.</p><div class="divider"></div><p class="legal-note small"><strong>Advise to Third Parties:</strong> Nothing in this certificate will affect your right as a Third Party to make a claim.</p><p class="legal-note small">Allianz is a trading name of Highway Insurance Company Limited which is part of the Allianz Group, registered in England and Wales number 3730626. Authorised by the Prudential Regulation Authority and regulated by the Financial Conduct Authority and the Prudential Regulation Authority, register number 202372. Registered address: 57 Ladymead, Guildford, Surrey, GU1 1DB.</p><p class="muted small">allianz.co.uk/brokercustomer</p></div></main>`
        );

        addPolicyPage(
          "Excess Protection Policy",
          `<main class="body"><div class="flow"><table class="kv-table" style="margin-bottom:8px;"><tbody><tr><th>Product:</th><td>Motor Excess Protection Insurance</td></tr><tr><th>Agents Name:</th><td>Ramasis Limited</td></tr><tr><th>Website Name:</th><td>safelyinsured.co.uk</td></tr></tbody></table><h2 class="center-text" style="letter-spacing:.03em;padding-top:20px;">POLICY SCHEDULE</h2><div class="divider"></div><p class="muted justify-text" style="margin-top:6px;">This insurance has been arranged through Ramasis Limited and is a contract between <em>you</em> and the <em>insurer</em>, Legal Protection Group. The <em>insurer</em> will indemnify the <em>insured person</em> subject to the terms, conditions, clauses and exclusions of this insurance for valid claims resulting from an <em>insured incident</em> during the <em>period of insurance</em> up to the <em>aggregate limit</em> as defined below. This <em>policy schedule</em> and the <em>policy</em> wording must be read as one and together they form your Motor Excess Protection Insurance.</p><table class="kv-table" style="margin-top:10px;margin-bottom:10px;"><tbody><tr><th>Policy Number:</th><td>IDLPG1000028</td></tr><tr><th>Policyholder Name:</th><td>Mr Reza Moghbel</td></tr><tr><th>Vehicle Registration:</th><td>RK17NSY</td></tr><tr><th>Period of Cover:</th><td>13/08/2025 at 17:55 hours until: 14/08/2025 at 17:55 hours</td></tr><tr><th>Aggregate Limit:</th><td>¬£250.00</td></tr></tbody></table><table class="premium-table" style="max-width:420px;margin-left:auto;"><tbody><tr><th class="kv-table-no-top-border" style="background:transparent;font-weight:700;">Policy Premium:</th><td class="kv-table-no-top-border">¬£0.73</td></tr><tr><th style="background:transparent;font-weight:700;">Insurance Premium Tax (IPT):</th><td>¬£0.09</td></tr><tr><th style="background:transparent;font-weight:700;">Total Premium:</th><td><strong>¬£0.82</strong></td></tr></tbody></table><div class="callout"><p class="kv-table-p" style="border:none;padding:0;margin:0 0 6px 0;"><strong>How to Claim:</strong></p><p class="justify-text" style="margin:0;">If you have unfortunately been involved in a claim that is either your <em>fault</em>, or partially your <em>fault</em>, or the <em>insured vehicle</em> has been stolen or damaged by fire, then please refer to your <em>policy</em> wording which explains the simple steps you need to take to submit a claim under this <em>policy</em>.</p></div><p style="margin-top:14px;">Certificate of Insurance</p><p>Short-term Motor Legal</p></div></main>`,
          `<header>
<div class="hdr">
  <div class="slot" style="flex:2 1 0"> <img alt="Left Logo" src="https://www.insuredaily.co.uk/web/assets/images/logo/InsureDaily_short_term_car_insurance_logo.webp"></div>
  <div class="slot" style="flex:1 1 0"></div>
  <div class="slot" style="flex:2 1 0"> <img alt="Left Logo" src="https://www.insuredaily.co.uk/web/assets/images/logo/InsureDaily_short_term_car_insurance_logo.webp"></div>
</div>
</header>`
        );

        addPolicyPage(
          "Legal Expenses Certificate",
          `<main class="body"><div class="flow"><div class="section"><table class="kv-table" style="margin-bottom:8px;"><tbody><tr class="kv-table-no-top-border"><th>Policyholder</th><td>Mr Reza Moghbel</td></tr><tr><th>Date Cover Commenced</th><td>13/08/2025 at 17:55 hours</td></tr><tr><th>Expiry Date</th><td>14/08/2025 at 17:55 hours</td></tr><tr><th>No. of Days</th><td>ONE DAY</td></tr><tr><th>Period of Insurance</th><td>From the Date Cover Commenced up to the renewal date of the motor insurance policy with which this insurance is issued ‚Äì such a period not to exceed 90 days</td></tr><tr><th>Certificate Number</th><td>IDLE000006</td></tr><tr><th>Price Paid</th><td>¬£0.34</td></tr></tbody></table><table class="matrix-table"><thead><tr><th style="width:46%;">Insurance Incident</th><th style="width:14%;">Application</th><th style="width:20%;">Limit of Liability</th><th style="width:10%;">Excess</th><th style="width:20%;">Amount in Dispute</th></tr></thead><tbody><tr><td>1. Recovery of Losses when an <strong>Insure Person</strong> is involved in a motor accident which is <strong>NOT</strong> the Insured Person's fault</td><td>Yes</td><td>¬£100,000</td><td>Nil</td><td>Not applicable</td></tr><tr><td>2. Defence of a Criminal Prosecution of a Motoring Offence</td><td>Yes</td><td>¬£100,000</td><td>¬£100</td><td>Not applicable</td></tr><tr><td>3. Motor Vehicle Contract Disputes</td><td>Yes</td><td>¬£100,000</td><td>Nil</td><td>¬£250</td></tr><tr><td>4. Vehicle Cloning</td><td>Yes</td><td>¬£100,000</td><td>Nil</td><td>Not applicable</td></tr><tr><td>5. Illegal Clamping and Towing</td><td>Yes</td><td>¬£100,000</td><td>Nil</td><td>¬£100</td></tr><tr><td>6. Unenforceable Parking Fines</td><td>Yes</td><td>¬£100,000</td><td>Nil</td><td>¬£100</td></tr><tr><td>7. Motor Insurance Database Disputes</td><td>Yes</td><td>¬£100,000</td><td>Nil</td><td>Not applicable</td></tr><tr><td>8. Licence Protection</td><td>Yes</td><td>¬£100,000</td><td>Nil</td><td>Not applicable</td></tr></tbody></table><p class="small-note" style="padding-bottom:5px;">The Limit of Liability under Insured Incidents 1, 2, 3, 4, 5, 6, 7 &amp; 8 is subject to an annual aggregate limit of <strong>¬£200,000</strong> in respect of all Insured Incidents in any one Period of Insurance.</p><p>This Certificate forms part of your Motor Legal Expenses Insurance Policy. This Certificate and the Insurance Policy should be read together as one document. This Certificate should be kept in a safe place together with your Policy.</p><div class="callout" style="width:20%;"><p class="kv-table-p" style="border:none;padding:0;margin:0 0 6px 0;"><strong>Logo</strong></p></div></div></div></main>`,
          `<header>
  <div class="hdr" data-mode="edges" data-equalize="true">
    <div class="slot">
      <img alt="Left Logo" src="https://www.insuredaily.co.uk/web/assets/images/logo/InsureDaily_short_term_car_insurance_logo.webp">
    </div>

    <div class="slot text">A text</div>

    <div class="slot">
      <img alt="Right Logo" src="https://www.insuredaily.co.uk/web/assets/images/logo/InsureDaily_short_term_car_insurance_logo.webp">
    </div>
  </div>
</header>`
        );

        addPolicyPage(
          "Customer Benefits",
          `<main class="body"><div class="flow"><h2 class="benefits-title">CUSTOMER BENEFITS</h2><p><strong>Breakdown Cover - Roadside Assistance &amp; Recovery</strong> service for breakdowns* during the period the vehicle is covered by your temporary motor insurance policy</p><p><strong>¬£250 Excess Reimbursement</strong> for any non-recoverable excess following a valid claim</p><p class="muted" style="color:#333;">At InsureDaily, we are committed to ensuring that our customers can drive with confidence, knowing that in the event of an accident or vehicle breakdown, they will experience minimal disruption. To provide peace of mind, we provide InsureDaily's customers with the above Customer Benefits when they arrange temporary motor insurance with us.</p><h4>What to do in the event of a Breakdown?</h4><p class="muted" style="color:#333;">If your vehicle has a breakdown during the period your vehicle is covered by an insurance InsureDaily has arranged for you, you can contact our Roadside Assistance &amp; Recovery service providers, Call Assist, by ringing the number below and advising them that you are a InsureDaily customer.</p><p class="note-asterisk">*Restrictions to the assistance provided are:</p><ul><li>The vehicle and date the breakdown occurred must be during the period of the motor insurance policy we arranged for you</li><li>The vehicle must be at least ¬æ of a mile from your home address</li><li>No cover outside of England, Scotland and Wales</li><li>Cover is for the vehicle only ‚Äì no cover for any trailer or caravan</li><li>Only covers movement of the vehicle and passengers within a 75-mile radius from where the vehicle breaks down</li><li>No cover for draining or removal of an incorrect fuel type</li><li>No assistance will be given if the vehicle is deemed unworthy or dangerous to transport</li><li>There is no cover for the costs of any parts, components or materials used to repair the vehicle</li></ul><p class="muted" style="color:#333;">If you have unfortunately broken down whilst driving your vehicle, phone <strong>Call Assist</strong> for assistance immediately on:</p><div class="helpline-orange" aria-label="Breakdown helpline"><span class="label">Breakdown:</span><span class="phone">01206 714303</span></div><h4>What to do to recover ¬£250 Excess?</h4><p class="muted" style="color:#333;">If you are involved in an incident where you cannot recover the Policy Excess on the motor insurance policy we arranged for you, InsureDaily will refund you up to ¬£250 of the excess amount you had to pay. To claim this refund, <strong>call the number below</strong>, after your vehicle has been repaired or declared a <strong>total loss</strong> and you have been required to pay your policy excess or it has been deducted from your total loss settlement. We will require evidence of the Excess amount you have paid or had deducted for your claim. Please note, where the accident was not your fault, the full Excess amount should be recovered from the Third Party's Insurer.</p><div class="helpline-orange" aria-label="Excess helpline"><span class="label">Excess:</span><span class="phone">01707 624 780</span></div></div></main>`,
          `<header>
<div class="hdr">
  <div class="slot" style="flex:1 1 0"> <img alt="Left Logo" src="https://www.insuredaily.co.uk/web/assets/images/logo/InsureDaily_short_term_car_insurance_logo.webp"></div>
  <div class="slot" style="flex:1 1 0"></div>
  <div class="slot" style="flex:1 1 0"> <img alt="Left Logo" src="https://www.insuredaily.co.uk/web/assets/images/logo/InsureDaily_short_term_car_insurance_logo.webp"></div>
</div>
</header>`
        );
      }

      function addPolicyPage(title, body, header = null) {
        pageCounter++;
        const pageId = `page-${pageCounter}`;
        const page = {
          id: pageId,
          title: title,
          pageNumber: pages.length + 1,
          sectionClass: "page",
          dataTitle: "Policy Details",
          showHeader: true,
          showFooter: true,
          body: body,
          header: header || "",
          footer: "",
          customCSS: "",
          customJS: "",
          hasCustomCSS: false,
          hasCustomJS: false,
          hasCustomHeader: header ? true : false,
          hasCustomFooter: false,
          isEditing: true,
          isSaved: false,
        };

        pages.push(page);
        // Update pageNumber after adding to array
        page.pageNumber = pages.length;
        renderPage(page);
      }

      function renderPage(page) {
        const container = document.getElementById("pagesContainer");
        const pageElement = document.createElement("div");
        pageElement.className = `page-item ${page.isEditing ? "editing" : ""}`;
        pageElement.id = `page-element-${page.id}`;

        pageElement.innerHTML = `
          <div class="page-header">
            <h3 class="page-title" id="page-title-${page.id}">Page ${
          page.pageNumber
        } (${page.title})</h3>
            <div class="page-actions">
              <button class="btn btn-sm ${
                page.isEditing ? "btn-success" : "btn-primary"
              }" 
                      onclick="toggleEdit('${page.id}')">
                ${page.isEditing ? "Save" : "Edit"}
              </button>
              <button class="btn btn-sm btn-danger" onclick="deletePage('${
                page.id
              }')">Delete</button>
            </div>
          </div>
          <div class="page-content ${page.isEditing ? "" : "disabled"}">
            <div class="form-group">
              <label>Page Title</label>
              <input type="text" value="${
                page.title
              }" onchange="updatePageTitle('${page.id}', this.value)" ${
          page.isEditing ? "" : "disabled"
        } />
            </div>
            
            <div class="form-group">
              <label>CSS Class Name</label>
              <input type="text" value="${
                page.sectionClass
              }" placeholder="e.g., page, section, content" onchange="updatePageProperty('${
          page.id
        }', 'sectionClass', this.value)" ${page.isEditing ? "" : "disabled"} />
              <small style="color: #666; font-size: 12px;">Enter a CSS class name (without the dot). Default CSS includes styles for "page" class.</small>
            </div>
            
            <div class="form-group">
              <label>Page Description</label>
              <input type="text" value="${
                page.dataTitle
              }" onchange="updatePageProperty('${
          page.id
        }', 'dataTitle', this.value)" ${page.isEditing ? "" : "disabled"} />
            </div>
            
            <div class="checkbox-group">
              <input type="checkbox" id="showHeader-${page.id}" ${
          page.showHeader ? "checked" : ""
        } 
                     onchange="updatePageProperty('${
                       page.id
                     }', 'showHeader', this.checked)" ${
          page.isEditing ? "" : "disabled"
        } />
              <label for="showHeader-${page.id}">Display Header</label>
            </div>
            
            <div class="checkbox-group">
              <input type="checkbox" id="showFooter-${page.id}" ${
          page.showFooter ? "checked" : ""
        } 
                     onchange="updatePageProperty('${
                       page.id
                     }', 'showFooter', this.checked)" ${
          page.isEditing ? "" : "disabled"
        } />
              <label for="showFooter-${page.id}">Display Footer</label>
            </div>
            
            <div class="checkbox-group">
              <input type="checkbox" id="hasCustomCSS-${page.id}" ${
          page.hasCustomCSS ? "checked" : ""
        } 
                     onchange="toggleCustomCSS('${page.id}', this.checked)" ${
          page.isEditing ? "" : "disabled"
        } />
              <label for="hasCustomCSS-${page.id}">Custom CSS</label>
            </div>
            
            <div class="form-group ${
              page.hasCustomCSS ? "" : "hidden"
            }" id="customCSS-${page.id}">
              <label>Custom CSS</label>
              <textarea onchange="updatePageProperty('${
                page.id
              }', 'customCSS', this.value)" ${
          page.isEditing ? "" : "disabled"
        }>${page.customCSS}</textarea>
            </div>
            
            <div class="checkbox-group">
              <input type="checkbox" id="hasCustomJS-${page.id}" ${
          page.hasCustomJS ? "checked" : ""
        } 
                     onchange="toggleCustomJS('${page.id}', this.checked)" ${
          page.isEditing ? "" : "disabled"
        } />
              <label for="hasCustomJS-${page.id}">Custom JavaScript</label>
            </div>
            
            <div class="form-group ${
              page.hasCustomJS ? "" : "hidden"
            }" id="customJS-${page.id}">
              <label>Custom JavaScript</label>
              <textarea onchange="updatePageProperty('${
                page.id
              }', 'customJS', this.value)" ${
          page.isEditing ? "" : "disabled"
        }>${page.customJS}</textarea>
            </div>
            
            <div class="form-group">
              <label>Page Content</label>
              <textarea onchange="updatePageProperty('${
                page.id
              }', 'body', this.value)" ${page.isEditing ? "" : "disabled"}>${
          page.body
        }</textarea>
            </div>
            
            <div class="checkbox-group">
              <input type="checkbox" id="hasCustomHeader-${page.id}" ${
          page.hasCustomHeader ? "checked" : ""
        } 
                     onchange="toggleCustomHeader('${
                       page.id
                     }', this.checked)" ${page.isEditing ? "" : "disabled"} />
              <label for="hasCustomHeader-${page.id}">Custom Header</label>
            </div>
            
            <div class="form-group" id="customHeader-${
              page.id
            }" style="display: ${page.hasCustomHeader ? "block" : "none"}">
              <label>Header Content</label>
              <textarea onchange="updatePageProperty('${
                page.id
              }', 'header', this.value)" ${page.isEditing ? "" : "disabled"}>${
          page.header
        }</textarea>
            </div>
            
            <div class="checkbox-group">
              <input type="checkbox" id="hasCustomFooter-${page.id}" ${
          page.hasCustomFooter ? "checked" : ""
        } 
                     onchange="toggleCustomFooter('${
                       page.id
                     }', this.checked)" ${page.isEditing ? "" : "disabled"} />
              <label for="hasCustomFooter-${page.id}">Custom Footer</label>
            </div>
            
            <div class="form-group" id="customFooter-${
              page.id
            }" style="display: ${page.hasCustomFooter ? "block" : "none"}">
              <label>Footer Content</label>
              <textarea onchange="updatePageProperty('${
                page.id
              }', 'footer', this.value)" ${page.isEditing ? "" : "disabled"}>${
          page.footer
        }</textarea>
            </div>
          </div>
        `;

        container.appendChild(pageElement);
      }

      function toggleEdit(pageId) {
        const page = pages.find((p) => p.id === pageId);
        if (page) {
          if (page.isEditing) {
            // Save the page (no JSON escaping - only save the raw content)
            page.isEditing = false;
            page.isSaved = true;
          } else {
            // Edit the page
            page.isEditing = true;
            page.isSaved = false;
          }
          renderAllPages();
        }
      }

      function deletePage(pageId) {
        if (confirm("Are you sure you want to delete this page?")) {
          pages = pages.filter((p) => p.id !== pageId);
          const pageElement = document.getElementById(`page-element-${pageId}`);
          if (pageElement) {
            pageElement.remove();
          }
          // Renumber all pages after deletion
          renumberPages();
        }
      }

      function renumberPages() {
        pages.forEach((page, index) => {
          page.pageNumber = index + 1;
          // Update the page title display
          const titleElement = document.getElementById(`page-title-${page.id}`);
          if (titleElement) {
            titleElement.textContent = `Page ${page.pageNumber} (${page.title})`;
          }
        });
      }

      function updatePageTitle(pageId, title) {
        const page = pages.find((p) => p.id === pageId);
        if (page) {
          page.title = title;
          // Update the page title display
          const titleElement = document.getElementById(`page-title-${pageId}`);
          if (titleElement) {
            titleElement.textContent = `Page ${page.pageNumber} (${page.title})`;
          }
        }
      }

      function updatePageProperty(pageId, property, value) {
        const page = pages.find((p) => p.id === pageId);
        if (page) {
          page[property] = value;
        }
      }

      function toggleCustomCSS(pageId, enabled) {
        const page = pages.find((p) => p.id === pageId);
        if (page) {
          page.hasCustomCSS = enabled;
          const cssDiv = document.getElementById(`customCSS-${pageId}`);
          if (cssDiv) {
            cssDiv.classList.toggle("hidden", !enabled);
          }
        }
      }

      function toggleCustomJS(pageId, enabled) {
        const page = pages.find((p) => p.id === pageId);
        if (page) {
          page.hasCustomJS = enabled;
          const jsDiv = document.getElementById(`customJS-${pageId}`);
          if (jsDiv) {
            jsDiv.classList.toggle("hidden", !enabled);
          }
        }
      }

      function toggleCustomHeader(pageId, enabled) {
        const page = pages.find((p) => p.id === pageId);
        if (page) {
          page.hasCustomHeader = enabled;
          const headerDiv = document.getElementById(`customHeader-${pageId}`);
          if (headerDiv) {
            headerDiv.style.display = enabled ? "block" : "none";
          }
        }
      }

      function toggleCustomFooter(pageId, enabled) {
        const page = pages.find((p) => p.id === pageId);
        if (page) {
          page.hasCustomFooter = enabled;
          const footerDiv = document.getElementById(`customFooter-${pageId}`);
          if (footerDiv) {
            footerDiv.style.display = enabled ? "block" : "none";
          }
        }
      }

      function renderAllPages() {
        const container = document.getElementById("pagesContainer");
        container.innerHTML = "";
        pages.forEach((page) => renderPage(page));
      }

      // Function to escape JSON strings
      function escapeJsonString(str) {
        if (!str) return str;
        return str
          .replace(/\\/g, "\\\\") // Escape backslashes
          .replace(/"/g, '\\"') // Escape double quotes
          .replace(/\n/g, "\\n") // Escape newlines
          .replace(/\r/g, "\\r") // Escape carriage returns
          .replace(/\t/g, "\\t") // Escape tabs
          .replace(/\f/g, "\\f") // Escape form feeds
          .replace(/\b/g, "\\b"); // Escape backspaces
      }

      // Function to unescape JSON strings for editing
      function unescapeJsonString(str) {
        if (!str) return str;
        return str
          .replace(/\\b/g, "\b") // Unescape backspaces
          .replace(/\\f/g, "\f") // Unescape form feeds
          .replace(/\\t/g, "\t") // Unescape tabs
          .replace(/\\r/g, "\r") // Unescape carriage returns
          .replace(/\\n/g, "\n") // Unescape newlines
          .replace(/\\"/g, '"') // Unescape double quotes
          .replace(/\\\\/g, "\\"); // Unescape backslashes (must be last)
      }

      // Function to check if a string is already JSON escaped (for Pages Management)
      function isJsonEscaped(str) {
        if (!str) return true;

        // Check if the string contains unescaped characters that need JSON escaping
        // If it contains unescaped quotes, newlines, or backslashes, it's not escaped
        const hasUnescapedQuotes = /[^\\]"/.test(str) || str.startsWith('"');
        const hasUnescapedNewlines =
          /[^\\]\n/.test(str) || str.startsWith("\n");
        const hasUnescapedCarriageReturns =
          /[^\\]\r/.test(str) || str.startsWith("\r");
        const hasUnescapedBackslashes = /[^\\]\\[^"nrtrbf]/.test(str);

        // If any unescaped characters are found, the string is not JSON escaped
        return (
          !hasUnescapedQuotes &&
          !hasUnescapedNewlines &&
          !hasUnescapedCarriageReturns &&
          !hasUnescapedBackslashes
        );
      }

      // Function to check if a string is already JSON escaped (for Global fields only)
      function isGlobalFieldJsonEscaped(str) {
        if (!str) return true;

        // Check if the string contains unescaped characters that need JSON escaping
        const hasUnescapedQuotes = /[^\\]"/.test(str) || str.startsWith('"');
        const hasUnescapedNewlines =
          /[^\\]\n/.test(str) || str.startsWith("\n");
        const hasUnescapedCarriageReturns =
          /[^\\]\r/.test(str) || str.startsWith("\r");
        const hasUnescapedTabs = /[^\\]\t/.test(str) || str.startsWith("\t");
        const hasUnescapedFormFeeds =
          /[^\\]\f/.test(str) || str.startsWith("\f");
        const hasUnescapedBackspaces =
          /[^\\]\b/.test(str) || str.startsWith("\b");
        const hasUnescapedBackslashes = /[^\\]\\[^"nrtrbf]/.test(str);

        // If any unescaped characters are found, the string is not JSON escaped
        return (
          !hasUnescapedQuotes &&
          !hasUnescapedNewlines &&
          !hasUnescapedCarriageReturns &&
          !hasUnescapedTabs &&
          !hasUnescapedFormFeeds &&
          !hasUnescapedBackspaces &&
          !hasUnescapedBackslashes
        );
      }

      // Function to update JSON escape indicators (removed - no longer needed)
      function updateJsonEscapeIndicators() {
        // No longer needed since JSON escaping only happens during JSON generation
      }

      // Function to update global field value (like updatePageProperty)
      function updateGlobalField(fieldId, value) {
        if (globalFields[fieldId]) {
          globalFields[fieldId].originalValue = value;
        }
      }

      // Function to toggle global field edit mode (like toggleEdit for pages)
      function toggleGlobalEdit(fieldId) {
        const field = globalFields[fieldId];
        const textarea = document.getElementById(fieldId);
        const button = document.getElementById(fieldId + "-btn");

        if (field.isEditing) {
          // Save the field (no JSON escaping - only save the raw content)
          field.isEditing = false;
          field.isSaved = true;
          field.originalValue = textarea.value;
          textarea.disabled = true;
          button.textContent = "Edit";
          button.className = "btn btn-sm btn-primary";
        } else {
          // Edit the field
          field.isEditing = true;
          field.isSaved = false;
          textarea.disabled = false;
          button.textContent = "Save";
          button.className = "btn btn-sm btn-success";
        }
      }

      // Function to reset all fields to defaults
      function resetToDefaults() {
        if (
          confirm(
            "Are you sure you want to reset all fields to their default values? This will clear all your changes."
          )
        ) {
          // Reset global fields
          globalFields = {
            globalCSS: { isEditing: false, isSaved: false, originalValue: "" },
            globalJS: { isEditing: false, isSaved: false, originalValue: "" },
            globalHeader: {
              isEditing: false,
              isSaved: false,
              originalValue: "",
            },
            globalFooter: {
              isEditing: false,
              isSaved: false,
              originalValue: "",
            },
          };

          // Reset pages
          pages = [];
          pageCounter = 0;

          // Reset form values
          document.getElementById("documentTitle").value = "A PDF Document";
          document.getElementById("pageSize").value = "A4";
          document.getElementById("marginTop").value = "0";
          document.getElementById("marginRight").value = "0";
          document.getElementById("marginBottom").value = "0";
          document.getElementById("marginLeft").value = "0";
          document.getElementById("headerHeight").value = "15";
          document.getElementById("footerHeight").value = "10";

          // Reset global textareas
          document.getElementById("globalCSS").value = "";
          document.getElementById("globalJS").value = "";
          document.getElementById("globalHeader").value = "";
          document.getElementById("globalFooter").value = "";

          // Reset buttons
          ["globalCSS", "globalJS", "globalHeader", "globalFooter"].forEach(
            (fieldId) => {
              const button = document.getElementById(fieldId + "-btn");
              button.textContent = "Edit";
              button.className = "btn btn-sm btn-primary";
              document.getElementById(fieldId).disabled = true;
            }
          );

          // Reinitialize with sample data
          initializeSampleData();
        }
      }

      // Function to save all pages and escape their content
      function saveAllPages() {
        // Only save pages, not global fields

        // Then save all pages (no JSON escaping - only mark as saved)
        pages.forEach((page) => {
          // Mark as saved
          page.isSaved = true;
          page.isEditing = false;
        });
        renderAllPages();
      }

      function generateJSON() {
        // First save all pages with JSON escaping
        saveAllPages();

        const globalCSS = document.getElementById("globalCSS").value;
        const globalJS = document.getElementById("globalJS").value;
        const globalHeader = document.getElementById("globalHeader").value;
        const globalFooter = document.getElementById("globalFooter").value;
        const documentTitle = document.getElementById("documentTitle").value;
        const pageSize = document.getElementById("pageSize").value;
        const marginTop = document.getElementById("marginTop").value;
        const marginRight = document.getElementById("marginRight").value;
        const marginBottom = document.getElementById("marginBottom").value;
        const marginLeft = document.getElementById("marginLeft").value;
        const headerHeight = document.getElementById("headerHeight").value;
        const footerHeight = document.getElementById("footerHeight").value;

        // Get SafeFrame options
        const safeFrameEnabled =
          document.getElementById("safeFrameEnabled").checked;
        const safeFrameStroke =
          document.getElementById("safeFrameStroke").value;
        const safeFrameColor = document.getElementById("safeFrameColor").value;
        const safeFrameTopOffset =
          document.getElementById("safeFrameTopOffset").value;
        const safeFrameBottomOffset = document.getElementById(
          "safeFrameBottomOffset"
        ).value;
        const safeFrameLeftOffset = document.getElementById(
          "safeFrameLeftOffset"
        ).value;
        const safeFrameRightOffset = document.getElementById(
          "safeFrameRightOffset"
        ).value;

        // Get Pagination options
        const useBuiltInPaginator = document.getElementById(
          "useBuiltInPaginator"
        ).checked;

        // Get Security options
        const sanitizeHtml = document.getElementById("sanitizeHtml").checked;
        const allowExternalResources = document.getElementById(
          "allowExternalResources"
        ).checked;

        // Use global content directly (no JSON escaping needed for API)
        const escapedGlobalCSS = globalCSS;
        const escapedGlobalJS = globalJS;
        const escapedGlobalHeader = globalHeader;
        const escapedGlobalFooter = globalFooter;

        const jsonData = {
          pdfDocumentBundle: {
            head: {
              title: documentTitle,
              meta: [
                { charset: "utf-8" },
                {
                  name: "viewport",
                  content: "width=device-width,initial-scale=1",
                },
              ],
              styles: escapedGlobalCSS
                ? [
                    {
                      type: "inline",
                      content:
                        "<style>\r\n" + escapedGlobalCSS + "\r\n</style>",
                    },
                  ]
                : [],
            },
            layout: {
              page: {
                size: pageSize,
                margin: {
                  top: marginTop + "mm",
                  right: marginRight + "mm",
                  bottom: marginBottom + "mm",
                  left: marginLeft + "mm",
                },
                headerHeight: headerHeight + "mm",
                footerHeight: footerHeight + "mm",
              },
              safeFrame: {
                enabled: safeFrameEnabled,
                stroke: safeFrameStroke + "px",
                color: safeFrameColor,
                topOffset: safeFrameTopOffset + "px",
                bottomOffset: safeFrameBottomOffset + "px",
                leftOffset: safeFrameLeftOffset + "px",
                rightOffset: safeFrameRightOffset + "px",
              },
              useBuiltInPaginator: useBuiltInPaginator,
            },
            security: {
              sanitizeHtml: sanitizeHtml,
              allowExternalResources: allowExternalResources,
            },
            body: {
              document: { class: "document" },
              pages: pages.map((page) => {
                const pageData = {
                  section: {
                    class: page.sectionClass,
                    dataTitle: page.dataTitle,
                  },
                  options: {
                    showHeader: page.showHeader,
                    showFooter: page.showFooter,
                  },
                  body: page.body,
                };

                // Add page-specific header if available
                if (page.hasCustomHeader && page.header) {
                  pageData.header = page.header;
                }

                // Add page-specific footer if available
                if (page.hasCustomFooter && page.footer) {
                  pageData.footer = page.footer;
                }

                if (page.hasCustomCSS && page.customCSS) {
                  pageData.styles = [
                    {
                      type: "inline",
                      content: "<style>\r\n" + page.customCSS + "\r\n</style>",
                    },
                  ];
                }

                if (page.hasCustomJS && page.customJS) {
                  pageData.scripts = [
                    {
                      type: "inline",
                      content:
                        "<" +
                        "script>\r\n" +
                        page.customJS +
                        "\r\n</" +
                        "script>",
                    },
                  ];
                }

                return pageData;
              }),
            },
            header: escapedGlobalHeader,
            footer: escapedGlobalFooter,
            scripts: escapedGlobalJS
              ? [
                  {
                    type: "inline",
                    content:
                      "<" +
                      "script>\r\n" +
                      escapedGlobalJS +
                      "\r\n</" +
                      "script>",
                  },
                ]
              : [],
          },
          pdfOptions: {
            format: pageSize,
            printBackground: true,
            margin: {
              top: marginTop,
              right: marginRight,
              bottom: marginBottom,
              left: marginLeft,
            },
          },
        };

        document.getElementById("jsonOutput").textContent = JSON.stringify(
          jsonData,
          null,
          2
        );
      }

      async function generatePDF() {
        // Create loading overlay
        const loadingOverlay = document.createElement("div");
        loadingOverlay.className = "loading-overlay";
        loadingOverlay.innerHTML = `
          <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Generating PDF</h3>
            <p>Please wait while we create your PDF document...</p>
          </div>
        `;
        document.body.appendChild(loadingOverlay);

        try {
          // First generate the JSON
          generateJSON();

          // Get the JSON data
          const jsonData = JSON.parse(
            document.getElementById("jsonOutput").textContent
          );

          // Show response area
          const responseOutput = document.getElementById("responseOutput");
          responseOutput.style.display = "block";
          document.getElementById("responseText").textContent =
            "Sending request to API...";

          // Send request to the bundle HTML to PDF endpoint
          const response = await fetch("/api/v1/bundle/bundleHtml2PDF", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(jsonData),
          });

          // Display response
          const responseText = document.getElementById("responseText");

          if (response.ok) {
            // Get the PDF blob
            const pdfBlob = await response.blob();

            // Create download link
            const url = window.URL.createObjectURL(pdfBlob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `generated-pdf-${Date.now()}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            responseText.textContent = `‚úÖ PDF generated successfully!\nStatus: ${
              response.status
            }\nSize: ${(pdfBlob.size / 1024).toFixed(
              2
            )} KB\n\nPDF has been downloaded automatically.`;
          } else {
            // Handle error response
            const errorText = await response.text();
            responseText.textContent = `‚ùå Error generating PDF:\nStatus: ${response.status}\nResponse: ${errorText}`;
          }
        } catch (error) {
          console.error("Error:", error);
          document.getElementById(
            "responseText"
          ).textContent = `‚ùå Network Error: ${error.message}`;
        } finally {
          // Remove loading overlay
          document.body.removeChild(loadingOverlay);
        }
      }

      // Make functions globally accessible
      window.addNewPage = addNewPage;
      window.toggleEdit = toggleEdit;
      window.deletePage = deletePage;
      window.updatePageTitle = updatePageTitle;
      window.updatePageProperty = updatePageProperty;
      window.toggleCustomCSS = toggleCustomCSS;
      window.toggleCustomJS = toggleCustomJS;
      window.toggleCustomHeader = toggleCustomHeader;
      window.toggleCustomFooter = toggleCustomFooter;
      window.renderAllPages = renderAllPages;
      window.saveAllPages = saveAllPages;
      window.generateJSON = generateJSON;
      window.generatePDF = generatePDF;
      window.toggleGlobalEdit = toggleGlobalEdit;
      window.resetToDefaults = resetToDefaults;

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        initializeSampleData();
      });
    </script>

    <!-- Health Status Widget -->
    <script src="../js/health-status.js"></script>
  </body>
</html>
